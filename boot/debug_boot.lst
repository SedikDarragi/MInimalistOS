     1                                  [org 0x7c00]
     2                                  [bits 16]
     3                                  
     4                                  KERNEL_OFFSET equ 0x1000  ; Where we'll load our kernel
     5                                  CODE_SEG equ 8
     6                                  DATA_SEG equ 16
     7                                  
     8                                  _start:
     9 00000000 E9D500                      jmp main
    10                                  
    11                                  print_str:
    12 00000003 60                          pusha
    13 00000004 B40E                        mov ah, 0x0E
    14                                  .loop:
    15 00000006 AC                          lodsb
    16 00000007 84C0                        test al, al
    17 00000009 7404                        jz .done
    18 0000000B CD10                        int 0x10
    19 0000000D EBF7                        jmp .loop
    20                                  .done:
    21 0000000F 61                          popa
    22 00000010 C3                          ret
    23                                  
    24                                  disk_load:
    25 00000011 60                          pusha
    26 00000012 B402                        mov ah, 0x02
    27 00000014 88F0                        mov al, dh
    28 00000016 B500                        mov ch, 0x00
    29 00000018 B600                        mov dh, 0x00
    30 0000001A B102                        mov cl, 0x02
    31 0000001C CD13                        int 0x13
    32 0000001E 7208                        jc .error
    33                                      ; Debug: Print 'D' to confirm disk load succeeded
    34 00000020 B044                        mov al, 'D'
    35 00000022 B40E                        mov ah, 0x0E
    36 00000024 CD10                        int 0x10
    37 00000026 61                          popa
    38 00000027 C3                          ret
    39                                  .error:
    40 00000028 BE[2201]                    mov si, msg_err
    41 0000002B E8D5FF                      call print_str
    42 0000002E EBFE                        jmp $
    43                                  
    44                                  ; GDT
    45                                  gdt_start:
    46                                      ; Null descriptor (required)
    47 00000030 0000000000000000            dq 0x0
    48                                      
    49                                      ; Code segment descriptor
    50 00000038 FFFF                        dw 0xFFFF     ; Limit (bits 0-15)
    51 0000003A 0000                        dw 0x0        ; Base (bits 0-15)
    52 0000003C 00                          db 0x0        ; Base (bits 16-23)
    53 0000003D 9A                          db 10011010b  ; Access byte
    54 0000003E CF                          db 11001111b  ; Flags + Limit (bits 16-19)
    55 0000003F 00                          db 0x0        ; Base (bits 24-31)
    56                                      
    57                                      ; Data segment descriptor
    58 00000040 FFFF                        dw 0xFFFF     ; Limit (bits 0-15)
    59 00000042 0000                        dw 0x0        ; Base (bits 0-15)
    60 00000044 00                          db 0x0        ; Base (bits 16-23)
    61 00000045 92                          db 10010010b  ; Access byte
    62 00000046 CF                          db 11001111b  ; Flags + Limit (bits 16-19)
    63 00000047 00                          db 0x0        ; Base (bits 24-31)
    64                                  
    65                                  gdt_end:
    66                                  
    67                                  gdt_descriptor:
    68 00000048 1700                        dw gdt_end - gdt_start - 1  ; Size of GDT
    69 0000004A [307C0000]                  dd gdt_start + 0x7C00      ; Base address of GDT (add load address)
    70                                  
    71                                  switch_to_pm:
    72                                      ; Debug: Print 'S' before switching to protected mode
    73 0000004E B053                        mov al, 'S'
    74 00000050 B40E                        mov ah, 0x0E
    75 00000052 CD10                        int 0x10
    76                                      
    77 00000054 FA                          cli
    78                                      
    79                                      ; Debug: Print 'G' without loading GDT first
    80 00000055 B047                        mov al, 'G'
    81 00000057 B40E                        mov ah, 0x0E
    82 00000059 CD10                        int 0x10
    83                                      
    84                                      ; Debug: Print 'L' immediately after G
    85 0000005B B04C                        mov al, 'L'
    86 0000005D B40E                        mov ah, 0x0E
    87 0000005F CD10                        int 0x10
    88                                      
    89                                      ; Load GDT - simple approach
    90 00000061 0F0116[4800]                lgdt [gdt_descriptor]
    91                                      
    92                                      ; Debug: Write 'M' to VGA to confirm GDT is loaded
    93 00000066 C60606804D                  mov byte [0xB8000+6], 'M'
    93          ******************       warning: word displacement exceeds bounds [-w+number-overflow]
    94 0000006B C606078009                  mov byte [0xB8000+7], 0x09
    94          ******************       warning: word displacement exceeds bounds [-w+number-overflow]
    95                                      
    96                                      ; Debug: Print 'T' after memory operations
    97 00000070 B054                        mov al, 'T'
    98 00000072 B40E                        mov ah, 0x0E
    99 00000074 CD10                        int 0x10
   100                                      
   101                                      ; Debug: Print 'L' after loading GDT
   102 00000076 B04C                        mov al, 'L'
   103 00000078 B40E                        mov ah, 0x0E
   104 0000007A CD10                        int 0x10
   105                                      
   106                                      ; Debug: Print 'C' before accessing CR0
   107 0000007C B043                        mov al, 'C'
   108 0000007E B40E                        mov ah, 0x0E
   109 00000080 CD10                        int 0x10
   110                                      
   111                                      ; Debug: Write 'C' to VGA before CR0 write
   112 00000082 C606008043                  mov byte [0xB8000], 'C'
   112          ******************       warning: word displacement exceeds bounds [-w+number-overflow]
   113 00000087 C60601800C                  mov byte [0xB8001], 0x0C
   113          ******************       warning: word displacement exceeds bounds [-w+number-overflow]
   114                                      
   115                                      ; Enable protected mode
   116 0000008C 0F20C0                      mov eax, cr0
   117 0000008F 6683C801                    or eax, 0x1
   118 00000093 0F22C0                      mov cr0, eax
   119                                      
   120                                      ; Debug: Write 'P' to VGA after CR0 write
   121 00000096 C606028050                  mov byte [0xB8002], 'P'
   121          ******************       warning: word displacement exceeds bounds [-w+number-overflow]
   122 0000009B C60603800E                  mov byte [0xB8003], 0x0E
   122          ******************       warning: word displacement exceeds bounds [-w+number-overflow]
   123                                      
   124                                      ; Debug: Write 'J' to VGA before the far jump
   125 000000A0 C60606804A                  mov byte [0xB8006], 'J'
   125          ******************       warning: word displacement exceeds bounds [-w+number-overflow]
   126 000000A5 C60607800A                  mov byte [0xB8007], 0x0A
   126          ******************       warning: word displacement exceeds bounds [-w+number-overflow]
   127                                      
   128                                      ; Far jump to flush pipeline and enter protected mode
   129 000000AA EAA57C0800                  jmp 0x08:0x7CA5
   130                                  
   131                                  [bits 32]
   132                                  protected_mode_entry:
   133                                      ; Set up data segment registers
   134 000000AF 66B81000                    mov ax, 0x10  ; Data selector
   135 000000B3 8ED8                        mov ds, ax
   136 000000B5 8ED0                        mov ss, ax
   137 000000B7 8EC0                        mov es, ax
   138 000000B9 8EE0                        mov fs, ax
   139 000000BB 8EE8                        mov gs, ax
   140                                      
   141                                      ; Debug: Write '3' to VGA to confirm we're in 32-bit protected mode
   142 000000BD C70504800B00330F33-         mov dword [0xB8004], 0x0F330F33  ; Two '3's
   142 000000C6 0F                 
   143                                      
   144                                      ; Debug: Write 'K' to VGA before jumping to kernel
   145 000000C7 C70508800B004B0B4B-         mov dword [0xB8008], 0x0B4B0B4B  ; Two 'K's
   145 000000D0 0B                 
   146                                      
   147                                      ; Jump to kernel entry point
   148 000000D1 EA1F3000000800              jmp 0x08:0x301F
   149                                  
   150                                  [bits 16]
   151                                  main:
   152 000000D8 FA                          cli
   153 000000D9 31C0                        xor ax, ax
   154 000000DB 8ED8                        mov ds, ax
   155 000000DD 8EC0                        mov es, ax
   156 000000DF 8ED0                        mov ss, ax
   157 000000E1 BC007C                      mov sp, 0x7c00
   158 000000E4 FB                          sti
   159                                      
   160 000000E5 8816[2601]                  mov [boot_drive], dl
   161                                      
   162 000000E9 BE[1601]                    mov si, msg_boot
   163 000000EC E814FF                      call print_str
   164                                      
   165 000000EF BB0010                      mov bx, KERNEL_OFFSET
   166 000000F2 8EC3                        mov es, bx
   167 000000F4 31DB                        xor bx, bx
   168 000000F6 B60F                        mov dh, 15
   169 000000F8 8A16[2601]                  mov dl, [boot_drive]
   170                                      
   171 000000FC BE[1D01]                    mov si, msg_load
   172 000000FF E801FF                      call print_str
   173 00000102 E80CFF                      call disk_load
   174                                      
   175                                      ; Debug: Print 'X' before calling switch_to_pm
   176 00000105 B058                        mov al, 'X'
   177 00000107 B40E                        mov ah, 0x0E
   178 00000109 CD10                        int 0x10
   179                                      
   180                                      ; Debug: Print another character to verify we're still here
   181 0000010B B059                        mov al, 'Y'
   182 0000010D B40E                        mov ah, 0x0E
   183 0000010F CD10                        int 0x10
   184                                      
   185 00000111 E93AFF                      jmp switch_to_pm
   186                                      
   187 00000114 EBFE                        jmp $
   188                                  
   189 00000116 426F6F740D0A00          msg_boot db 'Boot', 0x0D, 0x0A, 0
   190 0000011D 4C6F616400              msg_load db 'Load', 0
   191 00000122 45727200                msg_err db 'Err', 0
   192 00000126 00                      boot_drive db 0
   193                                  
   194                                  %if ($ - $$) > 510
   195                                      %error "Bootloader exceeds 510 bytes"
   196                                  %endif
   197 00000127 00<rep D7h>             times 510 - ($ - $$) db 0
   198 000001FE 55AA                    dw 0xAA55
