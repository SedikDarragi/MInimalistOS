     1                                  [org 0x7c00]
     2                                  [bits 16]
     3                                  
     4                                  KERNEL_OFFSET equ 0x1000  ; Where we'll load our kernel
     5                                  CODE_SEG equ 8
     6                                  DATA_SEG equ 16
     7                                  
     8                                  _start:
     9 00000000 E9A200                      jmp main
    10                                  
    11                                  print_str:
    12 00000003 60                          pusha
    13 00000004 B40E                        mov ah, 0x0E
    14                                  .loop:
    15 00000006 AC                          lodsb
    16 00000007 84C0                        test al, al
    17 00000009 7404                        jz .done
    18 0000000B CD10                        int 0x10
    19 0000000D EBF7                        jmp .loop
    20                                  .done:
    21 0000000F 61                          popa
    22 00000010 C3                          ret
    23                                  
    24                                  disk_load:
    25 00000011 60                          pusha
    26 00000012 88F3                        mov bl, dh
    27                                      
    28                                      ; Debug: Print 'R' to show we're in disk_load
    29 00000014 B052                        mov al, 'R'
    30 00000016 B40E                        mov ah, 0x0E
    31 00000018 CD10                        int 0x10
    32                                      
    33                                      ; Use CHS read for hard disk
    34 0000001A B402                        mov ah, 0x02
    35 0000001C 88D8                        mov al, bl
    36 0000001E B500                        mov ch, 0x00
    37 00000020 B600                        mov dh, 0x00
    38 00000022 B102                        mov cl, 0x02
    39 00000024 B280                        mov dl, 0x80
    40 00000026 CD13                        int 0x13
    41 00000028 7208                        jc .error
    42                                      
    43                                      ; Debug: Print 'D' to confirm disk load succeeded
    44 0000002A B044                        mov al, 'D'
    45 0000002C B40E                        mov ah, 0x0E
    46 0000002E CD10                        int 0x10
    47 00000030 61                          popa
    48 00000031 C3                          ret
    49                                      
    50                                  .error:
    51 00000032 B045                        mov al, 'E'
    52 00000034 B40E                        mov ah, 0x0E
    53 00000036 CD10                        int 0x10
    54 00000038 EBFE                        jmp $
    55                                  
    56                                  ; GDT
    57                                  gdt_start:
    58                                      ; Null descriptor (required)
    59 0000003A 0000000000000000            dq 0x0
    60                                      
    61                                      ; Code segment descriptor
    62 00000042 FFFF                        dw 0xFFFF
    63 00000044 0000                        dw 0x0
    64 00000046 00                          db 0x0
    65 00000047 9A                          db 10011010b
    66 00000048 CF                          db 11001111b
    67 00000049 00                          db 0x0
    68                                      
    69                                      ; Data segment descriptor
    70 0000004A FFFF                        dw 0xFFFF
    71 0000004C 0000                        dw 0x0
    72 0000004E 00                          db 0x0
    73 0000004F 92                          db 10010010b
    74 00000050 CF                          db 11001111b
    75 00000051 00                          db 0x0
    76                                  
    77                                  gdt_end:
    78                                  
    79                                  gdt_descriptor:
    80 00000052 1700                        dw gdt_end - gdt_start - 1
    81 00000054 [3A7C0000]                  dd gdt_start + 0x7C00
    82                                  
    83                                  [bits 16]
    84                                  switch_to_pm:
    85                                      ; Debug: Print 'S' before switching to protected mode
    86 00000058 B053                        mov al, 'S'
    87 0000005A B40E                        mov ah, 0x0E
    88 0000005C CD10                        int 0x10
    89                                      
    90 0000005E FA                          cli
    91                                      
    92                                      ; Load GDT
    93 0000005F 0F0116[5200]                lgdt [gdt_descriptor]
    94                                      
    95                                      ; Debug: Print 'G' after loading GDT
    96 00000064 B047                        mov al, 'G'
    97 00000066 B40E                        mov ah, 0x0E
    98 00000068 CD10                        int 0x10
    99                                      
   100                                      ; Enable protected mode
   101 0000006A 0F20C0                      mov eax, cr0
   102 0000006D 6683C801                    or eax, 0x1
   103 00000071 0F22C0                      mov cr0, eax
   104                                      
   105                                      ; Debug: Print 'P' after enabling protected mode
   106 00000074 B050                        mov al, 'P'
   107 00000076 B40E                        mov ah, 0x0E
   108 00000078 CD10                        int 0x10
   109                                      
   110                                      ; Far jump to 32-bit code
   111 0000007A EA[7F00]0800                jmp CODE_SEG:protected_mode_entry
   112                                  
   113                                  [bits 32]
   114                                  protected_mode_entry:
   115                                      ; Set up data segment registers
   116 0000007F 66B81000                    mov ax, DATA_SEG
   117 00000083 8ED8                        mov ds, ax
   118 00000085 8ED0                        mov ss, ax
   119 00000087 8EC0                        mov es, ax
   120 00000089 8EE0                        mov fs, ax
   121 0000008B 8EE8                        mov gs, ax
   122                                      
   123                                      ; Set up stack
   124 0000008D BC00000900                  mov esp, 0x90000
   125                                      
   126                                      ; Debug: Write '3' to VGA memory
   127 00000092 C60500800B0033              mov byte [0xB8000], '3'
   128 00000099 C60501800B000F              mov byte [0xB8001], 0x0F
   129                                      
   130                                      ; Jump to kernel
   131 000000A0 E9(00100000)                jmp KERNEL_OFFSET
   132                                  
   133                                  [bits 16]
   134                                  main:
   135 000000A5 FA                          cli
   136 000000A6 31C0                        xor ax, ax
   137 000000A8 8ED8                        mov ds, ax
   138 000000AA 8EC0                        mov es, ax
   139 000000AC 8ED0                        mov ss, ax
   140 000000AE BC0090                      mov sp, 0x9000
   141 000000B1 FB                          sti
   142                                      
   143 000000B2 8816[E000]                  mov [boot_drive], dl
   144                                      
   145 000000B6 BE[D500]                    mov si, msg_boot
   146 000000B9 E847FF                      call print_str
   147                                      
   148                                      ; Load kernel
   149 000000BC BB0010                      mov bx, KERNEL_OFFSET
   150 000000BF 8EC3                        mov es, bx
   151 000000C1 31DB                        xor bx, bx
   152 000000C3 B80000                      mov ax, 0x0000
   153 000000C6 8EC0                        mov es, ax
   154 000000C8 BB0010                      mov bx, KERNEL_OFFSET
   155 000000CB B620                        mov dh, 32
   156 000000CD B280                        mov dl, 0x80
   157 000000CF E83FFF                      call disk_load
   158                                      
   159                                      ; Switch to protected mode
   160 000000D2 E883FF                      call switch_to_pm
   161                                  
   162 000000D5 426F6F74696E672E2E-     msg_boot: db "Booting...", 0
   162 000000DE 2E00               
   163 000000E0 00                      boot_drive: db 0
   164                                  
   165 000000E1 00<rep 11Dh>            times 510 - ($-$$) db 0
   166 000001FE 55AA                    dw 0xAA55
