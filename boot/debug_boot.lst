     1                                  [org 0x7c00]
     2                                  [bits 16]
     3                                  
     4                                  KERNEL_OFFSET equ 0x1000
     5                                  CODE_SEG equ 8
     6                                  DATA_SEG equ 16
     7                                  
     8                                  _start:
     9 00000000 E9A200                      jmp main
    10                                  
    11                                  print_str:
    12 00000003 60                          pusha
    13 00000004 B40E                        mov ah, 0x0E
    14                                  .loop:
    15 00000006 AC                          lodsb
    16 00000007 84C0                        test al, al
    17 00000009 7404                        jz .done
    18 0000000B CD10                        int 0x10
    19 0000000D EBF7                        jmp .loop
    20                                  .done:
    21 0000000F 61                          popa
    22 00000010 C3                          ret
    23                                  
    24                                  disk_load:
    25 00000011 60                          pusha
    26 00000012 B402                        mov ah, 0x02
    27 00000014 88F0                        mov al, dh
    28 00000016 B500                        mov ch, 0x00
    29 00000018 B600                        mov dh, 0x00
    30 0000001A B102                        mov cl, 0x02
    31 0000001C CD13                        int 0x13
    32 0000001E 7208                        jc .error
    33                                      ; Debug: Print 'D' to confirm disk load succeeded
    34 00000020 B044                        mov al, 'D'
    35 00000022 B40E                        mov ah, 0x0E
    36 00000024 CD10                        int 0x10
    37 00000026 61                          popa
    38 00000027 C3                          ret
    39                                  .error:
    40 00000028 BE[E300]                    mov si, msg_err
    41 0000002B E8D5FF                      call print_str
    42 0000002E EBFE                        jmp $
    43                                  
    44                                  gdt_start:
    45 00000030 0000000000000000            dq 0x0
    46 00000038 FFFF                        dw 0xFFFF
    47 0000003A 0000                        dw 0x0
    48 0000003C 00                          db 0x0
    49 0000003D 9A                          db 10011010b
    50 0000003E CF                          db 11001111b
    51 0000003F 00                          db 0x0
    52 00000040 FFFF                        dw 0xFFFF
    53 00000042 0000                        dw 0x0
    54 00000044 00                          db 0x0
    55 00000045 92                          db 10010010b
    56 00000046 CF                          db 11001111b
    57 00000047 00                          db 0x0
    58                                  gdt_end:
    59                                  
    60                                  gdt_descriptor:
    61 00000048 1700                        dw gdt_end - gdt_start - 1
    62 0000004A [30000000]                  dd gdt_start
    63                                  
    64                                  switch_to_pm:
    65                                      ; Debug: Print 'S' before switching to protected mode
    66 0000004E B053                        mov al, 'S'
    67 00000050 B40E                        mov ah, 0x0E
    68 00000052 CD10                        int 0x10
    69                                      
    70 00000054 FA                          cli
    71 00000055 0F0116[4800]                lgdt [gdt_descriptor]
    72 0000005A 0F20C0                      mov eax, cr0
    73 0000005D 6683C801                    or eax, 0x1
    74 00000061 0F22C0                      mov cr0, eax
    75 00000064 EA[6900]0800                jmp CODE_SEG:init_pm
    76                                  
    77                                  [bits 32]
    78                                  init_pm:
    79 00000069 66B81000                    mov ax, DATA_SEG
    80 0000006D 8ED8                        mov ds, ax
    81 0000006F 8ED0                        mov ss, ax
    82 00000071 8EC0                        mov es, ax
    83 00000073 8EE0                        mov fs, ax
    84 00000075 8EE8                        mov gs, ax
    85 00000077 BD00000900                  mov ebp, 0x90000
    86 0000007C 89EC                        mov esp, ebp
    87                                      
    88                                      ; Debug: Write 'P' to VGA to confirm we're in protected mode
    89 0000007E C60500800B0050              mov byte [0xB8000], 'P'
    90 00000085 C60501800B000F              mov byte [0xB8001], 0x0F
    91                                      
    92                                      ; Debug: Write 'J' to VGA before jumping to kernel
    93 0000008C C60502800B004A              mov byte [0xB8002], 'J'
    94 00000093 C60503800B000A              mov byte [0xB8003], 0x0A
    95                                      
    96                                      ; Halt here temporarily to see if we reach this point
    97 0000009A FA                          cli
    98                                  .halt:
    99 0000009B F4                          hlt
   100 0000009C EBFD                        jmp .halt
   101                                      
   102 0000009E EA001000000800              jmp CODE_SEG:KERNEL_OFFSET
   103                                  
   104                                  [bits 16]
   105                                  main:
   106 000000A5 FA                          cli
   107 000000A6 31C0                        xor ax, ax
   108 000000A8 8ED8                        mov ds, ax
   109 000000AA 8EC0                        mov es, ax
   110 000000AC 8ED0                        mov ss, ax
   111 000000AE BC007C                      mov sp, 0x7c00
   112 000000B1 FB                          sti
   113                                      
   114 000000B2 8816[E700]                  mov [boot_drive], dl
   115                                      
   116 000000B6 BE[D700]                    mov si, msg_boot
   117 000000B9 E847FF                      call print_str
   118                                      
   119 000000BC BB0010                      mov bx, KERNEL_OFFSET
   120 000000BF 8EC3                        mov es, bx
   121 000000C1 31DB                        xor bx, bx
   122 000000C3 B60F                        mov dh, 15
   123 000000C5 8A16[E700]                  mov dl, [boot_drive]
   124                                      
   125 000000C9 BE[DE00]                    mov si, msg_load
   126 000000CC E834FF                      call print_str
   127 000000CF E83FFF                      call disk_load
   128                                      
   129                                      ; Skip OK message, go directly to protected mode
   130 000000D2 E879FF                      call switch_to_pm
   131                                      
   132 000000D5 EBFE                        jmp $
   133                                  
   134 000000D7 426F6F740D0A00          msg_boot db 'Boot', 0x0D, 0x0A, 0
   135 000000DE 4C6F616400              msg_load db 'Load', 0
   136 000000E3 45727200                msg_err db 'Err', 0
   137 000000E7 00                      boot_drive db 0
   138                                  
   139                                  %if ($ - $$) > 510
   140                                      %error "Bootloader exceeds 510 bytes"
   141                                  %endif
   142 000000E8 00<rep 116h>            times 510 - ($ - $$) db 0
   143 000001FE 55AA                    dw 0xAA55
